# Устранение проблем с визуализацией деревьев решений

## Обнаруженные проблемы

1. **Ошибка совместимости библиотек**

   - Ошибка: `ValueError: numpy.dtype size changed, may indicate binary incompatibility`
   - Решение: Фиксированные версии numpy и pandas в Dockerfile

2. **Ошибка с томами Docker**

   - Ошибка: `KeyError: 'ContainerConfig'`
   - Решение: Упрощенная конфигурация без монтирования томов

3. **Проблемы с доступом извне**
   - Проблема: Streamlit слушает только на localhost
   - Решение: Явное указание `--server.address=0.0.0.0`

## Предоставленные решения

### 1. Полное пересоздание контейнера

Скрипт `fix_container.sh` выполняет:

- Остановку всех контейнеров
- Удаление старого контейнера и образа
- Очистку томов
- Пересборку контейнера
- Запуск всех контейнеров

### 2. Упрощенная версия

Скрипт `start_simple.sh` запускает упрощенную версию:

- Использует `Dockerfile.simple` без монтирования томов
- Создает тестовые данные внутри контейнера
- Использует упрощенный `docker-compose.simple.yml`

### 3. Настройка Nginx

Скрипт `setup_nginx.sh` настраивает Nginx как прокси:

- Устанавливает Nginx (если не установлен)
- Создает конфигурацию для проксирования Streamlit
- Активирует конфигурацию и перезапускает Nginx

## Пошаговое руководство по устранению проблем

### Шаг 1: Попробуйте упрощенную версию

```bash
./start_simple.sh
```

Эта версия использует минимальную конфигурацию без монтирования томов, что должно решить проблему `KeyError: 'ContainerConfig'`.

### Шаг 2: Проверьте логи контейнера

```bash
docker-compose -f docker-compose.simple.yml logs -f decision-tree-viz
```

Если контейнер запускается, но веб-интерфейс недоступен, проверьте, что Streamlit слушает на всех интерфейсах:

```bash
docker exec -it ai-agent-visualization ps aux | grep streamlit
```

### Шаг 3: Настройте Nginx

Если прямой доступ к порту 8501 не работает, настройте Nginx:

```bash
./setup_nginx.sh
```

После этого веб-интерфейс должен быть доступен по адресу http://10.50.50.10/

### Шаг 4: Проверьте сетевые настройки

```bash
# Проверка открытых портов
netstat -tulpn | grep 8501

# Проверка доступности через curl
curl -v http://localhost:8501
curl -v http://10.50.50.10:8501
```

### Шаг 5: Проверьте брандмауэр

```bash
# Проверка статуса UFW
ufw status

# Если активен, откройте порты
ufw allow 8501/tcp
ufw allow 80/tcp
```

## Дополнительные рекомендации

1. **Используйте отдельный контейнер для визуализации**

   - Разделите AI агент и визуализацию на отдельные контейнеры
   - Используйте общий том для обмена данными

2. **Упростите конфигурацию**

   - Избегайте сложных монтирований томов
   - Используйте фиксированные версии библиотек

3. **Настройте Nginx**

   - Используйте Nginx как прокси для Streamlit
   - Это решит многие проблемы с доступом

4. **Проверьте сетевые настройки Docker**
   - Убедитесь, что контейнеры могут общаться между собой
   - Проверьте, что порты правильно проброшены
