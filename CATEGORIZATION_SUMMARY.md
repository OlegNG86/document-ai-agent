# Система категоризации и целевой проверки документов

## Обзор реализации

Была успешно реализована система категоризации документов и целевой проверки в соответствии с задачей 13 из спецификации проекта.

## Реализованные компоненты

### 1. Модель документа с категориями

**Файл:** `ai_agent/models/document.py`

- Добавлен enum `DocumentCategory` с тремя категориями:
  - `REFERENCE` - эталонные/нормативные документы
  - `TARGET` - целевые документы для проверки
  - `GENERAL` - обычные документы (по умолчанию)
- Добавлена поддержка тегов для документов
- Добавлены методы для работы с категориями и тегами:
  - `add_tag()`, `remove_tag()`
  - `set_category()`
  - `is_reference_document()`, `is_target_document()`

### 2. Расширенный DocumentManager

**Файл:** `ai_agent/core/document_manager.py`

- Обновлен метод `upload_document()` для поддержки категорий и тегов
- Добавлена фильтрация по категориям в методах поиска:
  - `search_similar_chunks()` с параметром `category_filter`
  - `list_documents()` с фильтрацией по категориям и тегам
- Новые методы для управления категориями:
  - `update_document_category()`
  - `update_document_tags()`
  - `get_reference_documents()`
  - `search_reference_chunks()`
- Обновлена статистика коллекции с разбивкой по категориям

### 3. Целевая проверка документов в QueryProcessor

**Файл:** `ai_agent/core/query_processor.py`

- Обновлен метод `process_document_check()` для поддержки:
  - Фильтрации только по эталонным документам
  - Выбора конкретных эталонных документов для проверки
- Добавлен метод `_get_context_from_specific_documents()`
- Улучшена точность проверки за счет использования только релевантных эталонных документов

### 4. Новые CLI команды

**Файл:** `ai_agent/cli/commands.py`

#### Новые команды:

- `upload-reference` - упрощенная загрузка эталонных документов
- `check-document` - проверка документов на соответствие с опциями:
  - `--interactive` - интерактивный выбор эталонных документов
  - `--reference-docs` - указание конкретных эталонных документов
- `manage-doc` - управление категориями и тегами документов

#### Обновленные команды:

- `upload` - добавлены параметры `--category` и `--tags`
- `batch-upload` - добавлены параметры `--category` и `--tags`
- `docs` - добавлены фильтры `--category` и `--tags`

#### Интерактивные функции:

- Интерактивный выбор эталонных документов с таблицей
- Детальные отчеты о соответствии с указанием источников
- Улучшенное отображение документов с категориями и тегами

### 5. Комплексные тесты

**Файл:** `tests/test_document_categorization.py`

- 15 тестов покрывающих все аспекты новой функциональности:
  - Тесты модели документа с категориями и тегами
  - Тесты DocumentManager с фильтрацией и управлением категориями
  - Тесты QueryProcessor с целевой проверкой
  - Тесты CLI интеграции

## Ключевые возможности

### 1. Категоризация документов

- Автоматическая категоризация при загрузке
- Изменение категорий существующих документов
- Фильтрация документов по категориям

### 2. Система тегов

- Добавление тегов при загрузке
- Управление тегами существующих документов
- Фильтрация по тегам

### 3. Целевая проверка документов

- Проверка против всех эталонных документов
- Интерактивный выбор конкретных эталонных документов
- Детальные отчеты о соответствии

### 4. Интерактивный интерфейс

- Таблицы с информацией о документах
- Интерактивный выбор эталонных документов
- Цветное форматирование вывода

## Примеры использования

### Загрузка эталонного документа

```bash
docai upload-reference "Закон о контрактной системе.txt" --tags "закон,основы"
```

### Пакетная загрузка с категорией

```bash
docai batch-upload ./normative-docs/ --category reference --tags "нормативы"
```

### Проверка документа с интерактивным выбором

```bash
docai check-document contract.txt --interactive
```

### Управление категориями

```bash
docai manage-doc DOC_ID --category reference --add-tag "новый-тег"
```

### Фильтрация документов

```bash
docai docs --list --category reference --tags "нормативы,требования"
```

## Обновленная документация

- **README.md** - добавлены разделы о категоризации и проверке документов
- **QUICKSTART.md** - добавлены примеры использования новой функциональности
- Подробные примеры интерактивной проверки документов

## Статус

✅ **Задача 13 полностью выполнена**

Все подзадачи из спецификации реализованы:

- ✅ Система тегов и категорий для документов
- ✅ CLI команда для загрузки эталонных документов
- ✅ CLI команда для проверки целевого документа
- ✅ Специальный режим проверки с выбором эталонных документов
- ✅ Фильтрация поиска только по эталонным документам
- ✅ Детальный отчет о соответствии с источниками
- ✅ CLI команда для управления категориями документов
- ✅ Интерактивный режим выбора эталонных документов
- ✅ Тесты для системы категоризации и целевой проверки
- ✅ Обновленная документация с примерами использования

Система готова к использованию и полностью интегрирована с существующей функциональностью проекта.
